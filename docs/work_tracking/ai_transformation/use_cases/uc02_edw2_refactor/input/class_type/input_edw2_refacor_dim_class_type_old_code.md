# dim_class_type
This is a set of combined examples of the input and output for the class type dimension. Each input file is listed separately as a section with the title of the input file first and then the code from the input. During an actual refactoring exercise, each of the output files would be created as a separate file as described in the project guidance. 

## ClassType_NonDV_01.sql
- This step is an interim step between the raw vault and the dimensional model in the old environment. This and others should be combined to create business vault objects in one dbt model if possible. 

```sql
-- =============================================================================
-- DBMS Name : SQL Server
-- Script Name : update_ClassType_NonDV_01
-- Description : Build the staging table ClassType_NonDV_01
-- Generated by : WhereScape RED Version 8.6.5.1 (build 211024-115652)
-- Generated for : Blue Cross of Idaho
-- Generated on : Saturday, December 10, 2022 at 18:10:47
-- Author : Dan Brickey
-- =============================================================================
-- Notes / History
--
CREATE PROCEDURE [SCHEMA.update_ClassType_NonDV_01].update_ClassType_NonDV_01
@p_sequence integer
, @p_job_name varchar(256)
, @p_task_name varchar(256)
, @p_job_id integer
, @p_task_id integer
, @p_return_msg varchar(1024) OUTPUT
, @p_status integer OUTPUT
AS
SET XACT_ABORT OFF -- Turn off auto abort on errors
SET NOCOUNT ON -- Turn off row count messages

--=====================================================
-- Control variables used in most programs
--=====================================================
DECLARE
@v_msgtext varchar(1024) -- Text for audit_trail
, @v_sql nvarchar(255) -- Text for SQL statements
, @v_set integer -- commit set
, @v_analyze_flag integer -- analyze flag
, @v_step integer -- return code
, @v_update_count integer -- no of records updated
, @v_insert_count integer -- no of records inserted
, @v_count integer -- General counter
, @v_db_code varchar(10) -- Database error code
, @v_db_msg varchar(1024) -- Database error message

--=====================================================
-- General Variables
--=====================================================
DECLARE
@v_return_status integer -- Update result status
, @v_getkey_status integer -- GetKey procedure status
, @v_row_count integer -- General row count
, @v_truncate_date datetime -- Used to set date to midnight
, @v_dss_source_system_key integer -- Used for dimension joins
, @v_dss_current_flag char(1) -- Used for dimension joins
, @v_dss_create_time datetime -- Used for date insert
, @v_dss_update_time datetime -- Used for date insert

--=====================================================
-- MAIN
--=====================================================
SELECT @v_step = 100
BEGIN TRY

-- Set initial variable values
SELECT
@v_set = 0
, @v_analyze_flag = 0
, @v_step = 200
, @v_update_count = 0
, @v_insert_count = 0
, @v_dss_source_system_key = 1
, @v_dss_current_flag = 'Y'
, @v_dss_create_time = GETDATE()
, @v_dss_update_time = GETDATE()

--=====================================================
-- Delete all existing data from the staging table
--=====================================================
SET @v_sql = N'TRUNCATE TABLE [TABLEOWNER].[ClassType_NonDV_01]'
EXEC @v_return_status = sp_executesql @v_sql

--=======================================================
-- Insert input records into ClassType_NonDV_01
--=======================================================
SET @v_step = 300

BEGIN TRANSACTION

INSERT INTO [TABLEOWNER].[ClassType_NonDV_01] WITH ( TABLOCK )
(
SourceID,
SourceDescription,
grgr_id,
cscs_id,
cscs_desc
)
SELECT
v_r_SourceBKCCLookup.SourceID,
MAX(v_r_SourceBKCCLookup.SourceDescription) SourceDescription,
v_group_combined_current.grgr_id,
v_groupclass_combined_current.cscs_id,
v_groupclass_combined_current.cscs_desc
FROM [TABLEOWNER].[v_group_combined_current] v_group_combined_current
JOIN [TABLEOWNER].[v_groupclass_combined_current] v_groupclass_combined_current
ON v_groupclass_combined_current.GRGR_CK = v_group_combined_current.GRGR_CK
AND v_groupclass_combined_current.BKCC_class = v_group_combined_current.BKCC_Group
left JOIN [TABLEOWNER].[v_r_SourceBKCCLookup] v_r_SourceBKCCLookup on v_groupclass_combined_current.BKCC_class = v_r_SourceBKCCLookup.SourceID
GROUP BY v_group_combined_current.GRGR_ID,v_groupclass_combined_current.CSCS_ID,v_groupclass_combined_current.CSCS_DESC,v_r_SourceBKCCLookup.SourceID

SELECT @v_insert_count = @@ROWCOUNT

COMMIT

--=====================================================
-- All Done report the results
--=====================================================

-- WsWrkTask(job,task,seq,insert,update,replace,delete,discard,reject,error)
EXEC [METABASE].WsWrkTask @p_job_id, @p_task_id, @p_sequence,
@v_insert_count,@v_update_count,0,0,0,0,0

-- Work out the return message
SET @v_step = 400
SET @p_status = 1
SET @p_return_msg = 'ClassType_NonDV_01 updated. ' + CONVERT(varchar,@v_insert_count) + ' new records. ' + CONVERT(varchar,@v_update_count) + ' records updated.'
IF @v_update_count > 0
BEGIN
SET @p_return_msg = @p_return_msg + ' WARNING: Updated records indicate a non unique business key'
SET @p_status = -1
END

RETURN 0
END TRY
BEGIN CATCH
SET @p_status = -2
SET @p_return_msg = SUBSTRING('ClassType_NonDV_01 update FAILED with error ' + CONVERT(varchar,ISNULL(ERROR_NUMBER(),0)) + ' Step ' + CONVERT(varchar,ISNULL(@v_step,0)) + '. Error Msg: ' + ERROR_MESSAGE(),1,1023)
END CATCH
IF XACT_STATE() <> 0
BEGIN
ROLLBACK TRANSACTION
END
RETURN 0
```

## ClassType_NonDV_02.sql
- This step is an interim step between the raw vault and the dimensional model in the old environment. This and others should be combined to create business vault objects in one dbt model if possible. 

```sql
-- =============================================================================
-- DBMS Name : SQL Server
-- Script Name : update_ClassType_NonDV_02
-- Description : Build the staging table ClassType_NonDV_02
-- Generated by : WhereScape RED Version 8.6.5.1 (build 211024-115652)
-- Generated for : Blue Cross of Idaho
-- Generated on : Saturday, December 10, 2022 at 18:10:58
-- Author : Dan Brickey
-- =============================================================================
-- Notes / History
--
CREATE PROCEDURE [SCHEMA.update_ClassType_NonDV_02].update_ClassType_NonDV_02
@p_sequence integer
, @p_job_name varchar(256)
, @p_task_name varchar(256)
, @p_job_id integer
, @p_task_id integer
, @p_return_msg varchar(1024) OUTPUT
, @p_status integer OUTPUT
AS
SET XACT_ABORT OFF -- Turn off auto abort on errors
SET NOCOUNT ON -- Turn off row count messages

--=====================================================
-- Control variables used in most programs
--=====================================================
DECLARE
@v_msgtext varchar(1024) -- Text for audit_trail
, @v_sql nvarchar(255) -- Text for SQL statements
, @v_set integer -- commit set
, @v_analyze_flag integer -- analyze flag
, @v_step integer -- return code
, @v_update_count integer -- no of records updated
, @v_insert_count integer -- no of records inserted
, @v_count integer -- General counter
, @v_db_code varchar(10) -- Database error code
, @v_db_msg varchar(1024) -- Database error message

--=====================================================
-- General Variables
--=====================================================
DECLARE
@v_return_status integer -- Update result status
, @v_getkey_status integer -- GetKey procedure status
, @v_row_count integer -- General row count
, @v_truncate_date datetime -- Used to set date to midnight
, @v_dss_source_system_key integer -- Used for dimension joins
, @v_dss_current_flag char(1) -- Used for dimension joins
, @v_dss_create_time datetime -- Used for date insert
, @v_dss_update_time datetime -- Used for date insert

--=====================================================
-- MAIN
--=====================================================
SELECT @v_step = 100
BEGIN TRY

-- Set initial variable values
SELECT
@v_set = 0
, @v_analyze_flag = 0
, @v_step = 200
, @v_update_count = 0
, @v_insert_count = 0
, @v_dss_source_system_key = 1
, @v_dss_current_flag = 'Y'
, @v_dss_create_time = GETDATE()
, @v_dss_update_time = GETDATE()

--=====================================================
-- Delete all existing data from the staging table
--=====================================================
SET @v_sql = N'TRUNCATE TABLE [TABLEOWNER].[ClassType_NonDV_02]'
EXEC @v_return_status = sp_executesql @v_sql

--=======================================================
-- Insert input records into ClassType_NonDV_02
--=======================================================
SET @v_step = 300

BEGIN TRANSACTION

INSERT INTO [TABLEOWNER].[ClassType_NonDV_02] WITH ( TABLOCK )
(
GroupIDClassID,
DualEligible,
OnExchange,
description,
effectivefromdate,
effectivetodate,
SourceID,
SourceDescription,
cscs_id,
cscs_desc,
dss_create_time,
dss_update_time
)
SELECT
rTrim(ClassType_NonDV_01.grgr_id)+LTRIM(ClassType_NonDV_01.cscs_id) GroupIDClassID,
CASE WHEN ClassType_NonDV_01.cscs_id is null
THEN 'No'
WHEN ClassType_NonDV_01.cscs_id = ''
THEN 'No'
WHEN SUBSTRING(ClassType_NonDV_01.cscs_id,0,2) = 'M'
THEN 'Yes'
ELSE 'No'
END DualEligible,
CASE WHEN ClassType_NonDV_01.cscs_id is null
THEN 'No'
WHEN ClassType_NonDV_01.cscs_id = ''
THEN 'No'
WHEN ClassType_NonDV_01.grgr_id = '10030052'
THEN 'No'
WHEN SUBSTRING(ClassType_NonDV_01.cscs_id,0,2) = 'X'
THEN 'Yes'
WHEN SUBSTRING(ClassType_NonDV_01.cscs_id,4,4) = 'X'
THEN 'Yes'
ELSE 'No'
END,
ISNULL(v_s_classtypedescription_mroc_bcidaho_current.description,'') description,
ISNULL(v_s_classtypeassignment_mroc_bcidaho_current.effectivefromdate,'1/1/2002') effectivefromdate,
ISNULL(v_s_classtypeassignment_mroc_bcidaho_current.effectivetodate,'12/31/2199') effectivetodate,
ClassType_NonDV_01.SourceID,
ClassType_NonDV_01.SourceDescription,
ClassType_NonDV_01.cscs_id,
ClassType_NonDV_01.cscs_desc,
@v_dss_create_time,
@v_dss_update_time
FROM [TABLEOWNER].[ClassType_NonDV_01] ClassType_NonDV_01
LEFT JOIN [TABLEOWNER].[v_s_classtypeassignment_mroc_bcidaho_current] v_s_classtypeassignment_mroc_bcidaho_current
ON v_s_classtypeassignment_mroc_bcidaho_current.GroupID = ClassType_NonDV_01.GRGR_ID
AND v_s_classtypeassignment_mroc_bcidaho_current.ClassID = ClassType_NonDV_01.CSCS_ID
AND v_s_classtypeassignment_mroc_bcidaho_current.BKCC_Class = ClassType_NonDV_01.SourceID
AND v_s_classtypeassignment_mroc_bcidaho_current.EffectiveToDate = (select max(ctax.EffectiveToDate)
FROM [TABLEOWNER].[v_s_classtypeassignment_mroc_bcidaho_current] ctax
WHERE v_s_classtypeassignment_mroc_bcidaho_current.GroupID = ctax.GroupID
AND v_s_classtypeassignment_mroc_bcidaho_current.ClassID = ctax.ClassID
AND v_s_classtypeassignment_mroc_bcidaho_current.BKCC_Class = ctax.BKCC_Class)
LEFT JOIN [TABLEOWNER].[v_s_classtypedescription_mroc_bcidaho_current] v_s_classtypedescription_mroc_bcidaho_current
on v_s_classtypeassignment_mroc_bcidaho_current.DescriptionPK = v_s_classtypedescription_mroc_bcidaho_current.DescriptionPK
AND v_s_classtypeassignment_mroc_bcidaho_current.BKCC_Class = v_s_classtypedescription_mroc_bcidaho_current.BKCC_ClassType

SELECT @v_insert_count = @@ROWCOUNT

COMMIT

--=====================================================
-- All Done report the results
--=====================================================

-- WsWrkTask(job,task,seq,insert,update,replace,delete,discard,reject,error)
EXEC [METABASE].WsWrkTask @p_job_id, @p_task_id, @p_sequence,
@v_insert_count,@v_update_count,0,0,0,0,0

-- Work out the return message
SET @v_step = 400
SET @p_status = 1
SET @p_return_msg = 'ClassType_NonDV_02 updated. ' + CONVERT(varchar,@v_insert_count) + ' new records. ' + CONVERT(varchar,@v_update_count) + ' records updated.'
IF @v_update_count > 0
BEGIN
SET @p_return_msg = @p_return_msg + ' WARNING: Updated records indicate a non unique business key'
SET @p_status = -1
END

RETURN 0
END TRY
BEGIN CATCH
SET @p_status = -2
SET @p_return_msg = SUBSTRING('ClassType_NonDV_02 update FAILED with error ' + CONVERT(varchar,ISNULL(ERROR_NUMBER(),0)) + ' Step ' + CONVERT(varchar,ISNULL(@v_step,0)) + '. Error Msg: ' + ERROR_MESSAGE(),1,1023)
END CATCH
IF XACT_STATE() <> 0
BEGIN
ROLLBACK TRANSACTION
END
RETURN 0
```

## dimClassType_NonDV.sql
- This object is the controller from the legacy code. This is the final step prior to creating the dimension. This should typically translate into a business vault computed satellite, either standard or effectivity, depending on how it works, and possibly a business vault hub and/or link to express the relationships if the business keys for this new satellite are not modelled in the raw vault. 

```sql
--==============================================================================
-- DBMS Name : SQL Server
-- Procedure Name : update_dimClassType_NonDV
-- Template : bci_wsl_sqlserver_proc_dv_stage_collation
-- Template Version : 8.5.1.0
-- Description : Update the Stage Table table dimClassType_NonDV
-- Generated by : WhereScape RED Version 8.6.5.1 (build 211024-115652)
-- Generated for : Blue Cross of Idaho
-- Generated on : Saturday, December 10, 2022 at 18:11:04
-- Author : Dan Brickey
--==============================================================================
-- Notes / History
--
CREATE PROCEDURE [SCHEMA.update_dimClassType_NonDV].update_dimClassType_NonDV
@p_sequence INTEGER
, @p_job_name VARCHAR(256)
, @p_task_name VARCHAR(256)
, @p_job_id INTEGER
, @p_task_id INTEGER
, @p_return_msg VARCHAR(1024) OUTPUT
, @p_status INTEGER OUTPUT

AS
SET XACT_ABORT OFF -- Turn off auto abort on errors
SET NOCOUNT ON -- Turn off row count messages

--=====================================================
-- Control variables used in most programs
--=====================================================

DECLARE
@v_msgtext VARCHAR(1024) -- Text for audit_trail
, @v_sql NVARCHAR(255) -- Text for SQL statements
, @v_step INTEGER -- return code
, @v_insert_count INTEGER -- no of records inserted

, @v_return_status INTEGER -- Update result status
, @v_current_datetime DATETIME -- Used for date insert

--=====================================================
-- General Variables
--=====================================================

--=====================================================
-- MAIN
--=====================================================
SET @v_step = 100

SET @v_insert_count = 0
SET @v_current_datetime = GETDATE()

BEGIN TRY

    --=====================================================
    -- Delete existing records
    --=====================================================
    SET @v_step = 200

    SET @v_sql = N'TRUNCATE TABLE [TABLEOWNER].[dimClassType_NonDV]';
    EXEC @v_return_status = sp_executesql @v_sql

    --=====================================================
    -- Insert new records
    --=====================================================
    SET @v_step = 300

    BEGIN TRANSACTION

      INSERT INTO [TABLEOWNER].[dimClassType_NonDV] WITH (TABLOCK)
      ( ClassTypeID
      , ClassTypeDescription
      , ClassID
      , ClassDescription
      , DualEligible
      , OnExchange
      , NKHash
      , Type1Hash
      , CreateDate
      , UpdateDate
      , SourceID
      , SourceDescription)
      SELECT  ClassType_NonDV_02.GroupIDClassID AS ClassTypeID
           , ClassType_NonDV_02.description AS ClassTypeDescription
           , ClassType_NonDV_02.cscs_id AS ClassID
           , ClassType_NonDV_02.cscs_desc AS ClassDescription
           , ClassType_NonDV_02.DualEligible AS DualEligible
           , ClassType_NonDV_02.OnExchange AS OnExchange
           , HASHBYTES('sha1',
               RTRIM(COALESCE(CAST(ClassType_NonDV_02.GroupIDClassID AS VARCHAR(MAX)),'null')) +'||'+
               RTRIM(COALESCE(CAST(ClassType_NonDV_02.SourceID AS VARCHAR(MAX)),'null'))
               ) AS NKHash
           , HASHBYTES('sha1',
               LTRIM(RTRIM(COALESCE(CAST(ClassType_NonDV_02.description AS VARCHAR(MAX)),'null'))) +'||'+
               LTRIM(RTRIM(COALESCE(CAST(ClassType_NonDV_02.cscs_id AS VARCHAR(MAX)),'null'))) +'||'+
               LTRIM(RTRIM(COALESCE(CAST(ClassType_NonDV_02.cscs_desc AS VARCHAR(MAX)),'null'))) +'||'+
               LTRIM(RTRIM(COALESCE(CAST(ClassType_NonDV_02.DualEligible AS VARCHAR(MAX)),'null'))) +'||'+
               LTRIM(RTRIM(COALESCE(CAST(ClassType_NonDV_02.OnExchange AS VARCHAR(MAX)),'null'))) +'||'+
               LTRIM(RTRIM(COALESCE(CAST(ClassType_NonDV_02.SourceDescription AS VARCHAR(MAX)),'null')))
               ) AS Type1Hash
           , dss_create_time AS CreateDate
           , dss_update_time AS UpdateDate
           , ClassType_NonDV_02.SourceID AS SourceID
           , ClassType_NonDV_02.SourceDescription AS SourceDescription
      FROM [TABLEOWNER].[ClassType_NonDV_02] ClassType_NonDV_02
      ;

      SELECT @v_insert_count = @@ROWCOUNT

    COMMIT

    --=====================================================
    -- All Done report the results
    --=====================================================
    SET @v_step = 400

    -- WsWrkTask(job,task,seq,insert,update,replace,delete,discard,reject,error)
    EXEC [METABASE].WsWrkTask @p_job_id, @p_task_id, @p_sequence,
     @v_insert_count,0,0,0,0,0,0

    SET @p_status = 1
    SET @p_return_msg = 'dimClassType_NonDV updated. '
      + CONVERT(VARCHAR,@v_insert_count) + ' new records.'

    RETURN 0

END TRY
BEGIN CATCH

    SET @p_status = -2
    SET @p_return_msg = SUBSTRING('update_dimClassType_NonDV FAILED with error '
      + CONVERT(VARCHAR,ISNULL(ERROR_NUMBER(),0))
      + ' Step ' + CONVERT(VARCHAR,ISNULL(@v_step,0))
      + '. Error Msg: ' + ERROR_MESSAGE(),1,1023)

END CATCH
IF XACT_STATE() <> 0
BEGIN
ROLLBACK TRANSACTION
END

RETURN 0
```

## dimClassType_base.sql
- This object is the dimensional object. In this case, a dimension. This would be a separate DBT model in the new EDW3 schema to create the dimension itself. 

```sql
--==============================================================================
-- DBMS Name : SQL Server 2012
-- Script Name : update_dimClassType_Base
-- Description : Update the Dimension table dimClassType_base
-- Generated by : WhereScape RED Version 8.6.6.1 (build 220216-231917)
-- Generated for : Blue Cross Of Idaho
-- Generated on : Tuesday, January 03, 2023 at 13:57:37
-- Author : Shreya Thacker
--==============================================================================
-- Notes / History
--

CREATE PROCEDURE [SCHEMA.update_dimClassType_Base].update_dimClassType_Base
@p_sequence integer
, @p_job_name varchar(256)
, @p_task_name varchar(256)
, @p_job_id integer
, @p_task_id integer
, @p_return_msg varchar(1024) OUTPUT
, @p_status integer OUTPUT
AS
SET XACT_ABORT OFF -- Turn off auto abort on errors
SET NOCOUNT ON -- Turn off row count messages

    --==========================================================================
    -- Control variables used in most programs
    --==========================================================================
    DECLARE
      @v_msgtext            varchar(1024) -- Text for audit_trail
    , @v_sql                nvarchar(255) -- Text for SQL statements
    , @v_set                integer       -- commit set
    , @v_analyze_flag       integer       -- analyze flag
    , @v_step               integer       -- step number
    , @v_insert_count       integer       -- no of records inserted
    , @v_update_count       integer       -- no of records updated
    , @v_change_count       integer       -- Used for history start/end dates
    , @v_count              integer       -- General counter
    , @v_db_code            varchar(10)   -- Database error code
    , @v_db_msg             varchar(1024) -- Database error message

    --==========================================================================
    -- General Variables
    --==========================================================================
    DECLARE
      @v_return_status      integer       -- Update result status
    , @v_row_count          integer       -- General row count
    , @v_status             integer       -- General status field
    , @v_getkey_status      integer       -- GetKey procedure status
    , @v_current_datetime   datetime      -- Used for create/update dates
    , @v_current_date       datetime      -- Used to set date to midnight
    --==========================================================================
    -- Main
    --==========================================================================
    BEGIN TRY

    SET @v_step             = 100
    SET @v_insert_count     = 0
    SET @v_update_count     = 0
    SET @v_change_count     = 0
    SET @v_current_datetime = GETDATE()
    SET @v_current_date     = CONVERT(DATETIME,CONVERT(VARCHAR,GETDATE(),112),112)


    --==========================================================================
    -- Include 0 key row for when lookup to this table is null
    --==========================================================================
    SET @v_step = 200
    SET @v_count = 0

    SELECT @v_count = 1
    FROM  [TABLEOWNER].[dimClassType_base]
    WHERE ClassTypePK = 0

    IF @v_count = 0
    BEGIN
        SET @v_step = 300
        BEGIN TRANSACTION

        -- Allow explicit value to be inserted into IDENTITY field
        SET IDENTITY_INSERT [TABLEOWNER].[dimClassType_base] ON

        INSERT INTO [TABLEOWNER].[dimClassType_base]
        ( ClassTypePK
        , ClassTypeID
        , ClassTypeDescription
        , ClassID
        , ClassDescription
        , DualEligible
        , OnExchange
        , NKHash
        , Type1Hash
        , CreateDate
        , UpdateDate
        , SourceID
        , SourceDescription
        , dss_current_flag
        , dss_version
        , dss_start_date
        , dss_end_date
        , dss_update_time
        , dss_create_time
        )
        VALUES
        ( 0
        , NULL
        , SUBSTRING('Unknown',1,128)
        , SUBSTRING('Unknown',1,4)
        , SUBSTRING('Unknown',1,70)
        , SUBSTRING('Unknown',1,3)
        , SUBSTRING('Unknown',1,3)
        , NULL
        , NULL
        , NULL
        , NULL
        , SUBSTRING('Unknown',1,50)
        , SUBSTRING('Unknown',1,50)
        , 'Y'
        , 1
        , CAST('01-JAN-1900' AS datetime)
        , CAST('31-DEC-2999' AS datetime)
        , GETDATE()
        , GETDATE()
        )

        SELECT @v_row_count = @@ROWCOUNT

        -- Restore default handling of IDENTITY field
        SET IDENTITY_INSERT [TABLEOWNER].[dimClassType_base] OFF
        COMMIT
    END

    --==========================================================================
    -- Update expiring rows
    --==========================================================================
    UPDATE [TABLEOWNER].[dimClassType_base] WITH ( TABLOCK )
    SET     dss_end_date = @v_current_date -0.00000005
          , dss_current_flag = 'N'
          , dss_update_time = @v_current_datetime
    FROM
    (
        SELECT dimClassType_NonDV.ClassTypeID    ClassTypeID
             , dimClassType_NonDV.ClassTypeDescription    ClassTypeDescription
             , dimClassType_NonDV.ClassID    ClassID
             , dimClassType_NonDV.ClassDescription    ClassDescription
             , dimClassType_NonDV.DualEligible    DualEligible
             , dimClassType_NonDV.OnExchange    OnExchange
             , dimClassType_NonDV.NKHash    NKHash
             , dimClassType_NonDV.Type1Hash    Type1Hash
             , dimClassType_NonDV.CreateDate    CreateDate
             , dimClassType_NonDV.UpdateDate    UpdateDate
             , dimClassType_NonDV.SourceID    SourceID
             , dimClassType_NonDV.SourceDescription    SourceDescription
        FROM [TABLEOWNER].[dimClassType_NonDV] dimClassType_NonDV
        EXCEPT
        SELECT dimClassType_base.ClassTypeID    ClassTypeID
         , dimClassType_base.ClassTypeDescription    ClassTypeDescription
         , dimClassType_base.ClassID    ClassID
         , dimClassType_base.ClassDescription    ClassDescription
         , dimClassType_base.DualEligible    DualEligible
         , dimClassType_base.OnExchange    OnExchange
         , dimClassType_base.NKHash    NKHash
         , dimClassType_base.Type1Hash    Type1Hash
         , dimClassType_base.CreateDate    CreateDate
         , dimClassType_base.UpdateDate    UpdateDate
         , dimClassType_base.SourceID    SourceID
         , dimClassType_base.SourceDescription    SourceDescription
        FROM [TABLEOWNER].[dimClassType_base]
        WHERE dimClassType_base.dss_current_flag = 'Y'
    ) AS changes
    WHERE dimClassType_base.ClassTypeID = changes.ClassTypeID
    AND   dimClassType_base.SourceID = changes.SourceID
    AND   dimClassType_base.dss_current_flag = 'Y'
    AND  (
             (   dimClassType_base.NKHash <> changes.NKHash
            OR ( dimClassType_base.NKHash IS     NULL AND changes.NKHash IS NOT NULL )
            OR ( dimClassType_base.NKHash IS NOT NULL AND changes.NKHash IS     NULL )
             )
           )

    SELECT @v_row_count = @@ROWCOUNT

    SET @v_change_count = @v_row_count
    SET @v_update_count = @v_update_count + @v_row_count

    SET @v_step = 400

    --==========================================================================
    -- Update changed rows
    --==========================================================================
    UPDATE [TABLEOWNER].[dimClassType_base] WITH ( TABLOCK )
    SET     ClassTypeDescription =  changes.ClassTypeDescription
          , ClassID =  changes.ClassID
          , ClassDescription =  changes.ClassDescription
          , DualEligible =  changes.DualEligible
          , OnExchange =  changes.OnExchange
          , Type1Hash =  changes.Type1Hash
          , CreateDate =  changes.CreateDate
          , UpdateDate =  changes.UpdateDate
          , SourceDescription =  changes.SourceDescription
          , dss_update_time = @v_current_datetime
    FROM
    (
        SELECT dimClassType_NonDV.ClassTypeID    ClassTypeID
             , dimClassType_NonDV.ClassTypeDescription    ClassTypeDescription
             , dimClassType_NonDV.ClassID    ClassID
             , dimClassType_NonDV.ClassDescription    ClassDescription
             , dimClassType_NonDV.DualEligible    DualEligible
             , dimClassType_NonDV.OnExchange    OnExchange
             , dimClassType_NonDV.NKHash    NKHash
             , dimClassType_NonDV.Type1Hash    Type1Hash
             , dimClassType_NonDV.CreateDate    CreateDate
             , dimClassType_NonDV.UpdateDate    UpdateDate
             , dimClassType_NonDV.SourceID    SourceID
             , dimClassType_NonDV.SourceDescription    SourceDescription
        FROM [TABLEOWNER].[dimClassType_NonDV] dimClassType_NonDV
        EXCEPT
        SELECT dimClassType_base.ClassTypeID    ClassTypeID
             , dimClassType_base.ClassTypeDescription    ClassTypeDescription
             , dimClassType_base.ClassID    ClassID
             , dimClassType_base.ClassDescription    ClassDescription
             , dimClassType_base.DualEligible    DualEligible
             , dimClassType_base.OnExchange    OnExchange
             , dimClassType_base.NKHash    NKHash
             , dimClassType_base.Type1Hash    Type1Hash
             , dimClassType_base.CreateDate    CreateDate
             , dimClassType_base.UpdateDate    UpdateDate
             , dimClassType_base.SourceID    SourceID
             , dimClassType_base.SourceDescription    SourceDescription
        FROM [TABLEOWNER].[dimClassType_base]
        WHERE dimClassType_base.dss_current_flag = 'Y'
    ) AS changes
    WHERE dimClassType_base.ClassTypeID = changes.ClassTypeID
    AND   dimClassType_base.SourceID = changes.SourceID
    AND   dimClassType_base.dss_current_flag = 'Y'

    SELECT @v_row_count = @@ROWCOUNT

    SET @v_update_count = @v_update_count + @v_row_count

    SET @v_step = 500

    --==========================================================================
    -- Insert new records
    --==========================================================================
    INSERT INTO [TABLEOWNER].[dimClassType_base] WITH ( TABLOCK )
    ( ClassTypeID
    , ClassTypeDescription
    , ClassID
    , ClassDescription
    , DualEligible
    , OnExchange
    , NKHash
    , Type1Hash
    , CreateDate
    , UpdateDate
    , SourceID
    , SourceDescription
    , dss_start_date
    , dss_end_date
    , dss_current_flag
    , dss_version
    , dss_create_time
    , dss_update_time
    )
    SELECT
           dimClassType_NonDV.ClassTypeID
         , dimClassType_NonDV.ClassTypeDescription
         , dimClassType_NonDV.ClassID
         , dimClassType_NonDV.ClassDescription
         , dimClassType_NonDV.DualEligible
         , dimClassType_NonDV.OnExchange
         , dimClassType_NonDV.NKHash
         , dimClassType_NonDV.Type1Hash
         , dimClassType_NonDV.CreateDate
         , dimClassType_NonDV.UpdateDate
         , dimClassType_NonDV.SourceID
         , dimClassType_NonDV.SourceDescription
         , CASE WHEN vers.ClassTypeID IS NULL
                THEN CAST('01-JAN-1900' AS datetime)
                ELSE @v_current_date
           END
         , CAST('31-DEC-2999' AS datetime)
         , 'Y'
         , CASE WHEN vers.ClassTypeID IS NULL
                THEN 1
                ELSE vers.dss_version + 1
                END
         , @v_current_datetime
         , @v_current_datetime
    FROM [TABLEOWNER].[dimClassType_NonDV] dimClassType_NonDV
    LEFT OUTER JOIN (
          SELECT ClassTypeID
               , SourceID
               , MAX(dss_version) dss_version
          FROM [TABLEOWNER].[dimClassType_base] dimClassType_base
          GROUP BY ClassTypeID
                 , SourceID
    ) AS vers
    ON    dimClassType_NonDV.ClassTypeID = vers.ClassTypeID
    AND   dimClassType_NonDV.SourceID = vers.SourceID
    EXCEPT
    SELECT dimClassType_base.ClassTypeID    ClassTypeID
             , dimClassType_base.ClassTypeDescription    ClassTypeDescription
             , dimClassType_base.ClassID    ClassID
             , dimClassType_base.ClassDescription    ClassDescription
             , dimClassType_base.DualEligible    DualEligible
             , dimClassType_base.OnExchange    OnExchange
             , dimClassType_base.NKHash    NKHash
             , dimClassType_base.Type1Hash    Type1Hash
             , dimClassType_base.CreateDate    CreateDate
             , dimClassType_base.UpdateDate    UpdateDate
             , dimClassType_base.SourceID    SourceID
             , dimClassType_base.SourceDescription    SourceDescription
           , @v_current_date
           , CAST('31-DEC-2999' AS datetime)
           , 'Y'
           , dss_version + 1
           , @v_current_datetime
           , @v_current_datetime
    FROM [TABLEOWNER].[dimClassType_base]
    WHERE dimClassType_base.dss_current_flag = 'Y'

    SELECT @v_row_count = @@ROWCOUNT

    SET @v_insert_count = @v_insert_count + @v_row_count


    SET @v_step = 600

    --==========================================================================
    -- Final settings
    --==========================================================================

    -- WsWrkTask(job,task,seq,insert,update,replace,delete,discard,reject,error)
    EXEC [METABASE].WsWrkTask @p_job_id, @p_task_id, @p_sequence,
        @v_insert_count, @v_update_count, 0, 0, 0, 0, 0

    SET @v_step = 700

    -- Work out the return message

    SET @p_status = 1
    SET @p_return_msg = 'dimClassType_base updated. '
        + CONVERT(varchar,@v_insert_count) + ' records added. '
        + CONVERT(varchar,@v_update_count) + ' records updated. '

    END TRY
    BEGIN CATCH
        SET @p_status = -2
        SET @p_return_msg = SUBSTRING('dimClassType_base update FAILED'
            + '. Step ' + CONVERT(varchar,ISNULL(@v_step,0))
            + '. Error Num: ' + CONVERT(varchar,ISNULL(ERROR_NUMBER(),0))
            + '. Error Msg: ' + ERROR_MESSAGE(),1,1023)
    END CATCH
    IF XACT_STATE() <> 0
    BEGIN
        ROLLBACK TRANSACTION
    END
    RETURN 0
```
