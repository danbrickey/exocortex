version: 2

models:
  - name: ces_member_cob_profile
    description: |
      Computed Effectivity Satellite providing temporally accurate COB (Coordination of Benefits)
      status for members across Medical, Dental, and Drug coverage types.

      **Business Purpose**:
      Determines which insurance carrier is primary, secondary, or tertiary for billing purposes
      and identifies special scenarios like "Two Blues" coverage and Medicare Part D coordination.

      **Grain**: One row per member per discrete date range where COB status remains constant

      **Refresh Pattern**: Incremental (daily) - only processes members with eligibility or COB changes

      **Legacy Source**: HDSVault.biz.spCOBProfileLookup

      **Critical Dependency For**:
      - PCP Attribution (bridge_member_pcp_attribution)
      - Claims processing and adjudication
      - Quality measures (HEDIS)
      - Financial reporting

      **Data Quality Notes**:
      - No gaps allowed in member date coverage once member appears
      - No overlapping date ranges allowed per member
      - COB order can differ across Medical, Dental, and Drug coverage types

    config:
      tags: ['business_vault', 'cob', 'member', 'effectivity_satellite', 'daily']

    tests:
      - dbt_utils.recency:
          datepart: day
          field: load_date
          interval: 1
          config:
            severity: warn

      # Ensure no duplicates on unique key
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - source
            - member_bk
            - effective_date
          config:
            severity: error

    columns:
      # ========================================================================
      # Hub Keys & Business Keys
      # ========================================================================
      - name: member_hk
        description: "Surrogate key (hash) to h_member hub"
        tests:
          - not_null
          - relationships:
              to: ref('h_member')
              field: member_hk
              config:
                severity: error

      - name: source
        description: "Source system identifier (gemstone_facets or legacy_facets)"
        tests:
          - not_null
          - accepted_values:
              values: ['gemstone_facets', 'legacy_facets']
              config:
                severity: error

      - name: member_bk
        description: "Member business key (MEME_CK from source system)"
        tests:
          - not_null

      # ========================================================================
      # Effectivity Dates (SCD2 Pattern)
      # ========================================================================
      - name: effective_date
        description: |
          Start date of this COB period (inclusive). This date is calculated from the
          date spine logic that creates discrete, non-overlapping periods based on all
          eligibility and COB effective/term dates.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: date

      - name: end_date
        description: |
          End date of this COB period (inclusive). Value of '9999-12-31' indicates
          the current/active record for the member.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: date

      - name: is_current
        description: "Boolean flag indicating if this is the current/active COB record (end_date = '9999-12-31')"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      # ========================================================================
      # Member Demographics
      # ========================================================================
      - name: group_id
        description: "Group ID (GRGR_ID) - employer/sponsor group identifier"
        tests:
          - not_null

      - name: subscriber_id
        description: "Subscriber ID (SBSB_ID) - policy holder identifier"
        tests:
          - not_null

      - name: member_suffix
        description: "Member suffix (MEME_SFX) - family position on policy"
        tests:
          - not_null

      - name: member_first_name
        description: "Member first name for display purposes"

      # ========================================================================
      # Medical COB Attributes
      # ========================================================================
      - name: medical_coverage
        description: "Indicates if member has active medical coverage during this period"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: has_medical_cob
        description: "Indicates if member has COB coordination for medical claims"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: medical_cob_order
        description: |
          BCI's position in the medical payer order:
          - 'Primary': BCI pays first
          - 'Secondary': Another insurer pays first, BCI pays second
          - 'Tertiary': BCI pays third
          - 'No': No COB coordination
        tests:
          - not_null
          - accepted_values:
              values: ['Primary', 'Secondary', 'Tertiary', 'No']

      - name: medical_is_bci_primary
        description: "Derived flag: 'Yes' if medical_cob_order = 'Primary'"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: medical_is_bci_secondary
        description: "Derived flag: 'Yes' if medical_cob_order = 'Secondary'"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: medical_is_bci_tertiary
        description: "Derived flag: 'Yes' if medical_cob_order = 'Tertiary'"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: medical_carrier_id
        description: "Insurance carrier code (MCRE_ID) for medical COB - references other insurance company"

      - name: medical_two_blues
        description: |
          Indicates 'Two Blues' scenario where member has both BCI and another
          Blue Cross Blue Shield plan for medical coverage. Affects billing and
          coordination rules.
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      # ========================================================================
      # Dental COB Attributes
      # ========================================================================
      - name: dental_coverage
        description: "Indicates if member has active dental coverage during this period"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: has_dental_cob
        description: "Indicates if member has COB coordination for dental claims"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: dental_cob_order
        description: |
          BCI's position in the dental payer order:
          - 'Primary': BCI pays first
          - 'Secondary': Another insurer pays first, BCI pays second
          - 'Tertiary': BCI pays third
          - 'No': No COB coordination
        tests:
          - not_null
          - accepted_values:
              values: ['Primary', 'Secondary', 'Tertiary', 'No']

      - name: dental_is_bci_primary
        description: "Derived flag: 'Yes' if dental_cob_order = 'Primary'"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: dental_is_bci_secondary
        description: "Derived flag: 'Yes' if dental_cob_order = 'Secondary'"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: dental_is_bci_tertiary
        description: "Derived flag: 'Yes' if dental_cob_order = 'Tertiary'"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: dental_carrier_id
        description: "Insurance carrier code (MCRE_ID) for dental COB"

      - name: dental_two_blues
        description: "Indicates 'Two Blues' scenario for dental coverage"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      # ========================================================================
      # Drug/Pharmacy COB Attributes
      # ========================================================================
      - name: drug_coverage
        description: |
          Indicates if member has active pharmacy/drug coverage during this period.
          Based on Medical (M) or Pharmacy (R) eligibility category.
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: has_drug_cob
        description: "Indicates if member has COB coordination for pharmacy claims"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: drug_cob_order
        description: |
          BCI's position in the pharmacy payer order:
          - 'Primary': BCI pays first
          - 'Secondary': Another insurer pays first (often Medicare Part D)
          - 'Tertiary': BCI pays third
          - 'No': No COB coordination

          Note: Special Medicare Part D rules apply - see seed files for logic.
        tests:
          - not_null
          - accepted_values:
              values: ['Primary', 'Secondary', 'Tertiary', 'No']

      - name: drug_is_bci_primary
        description: "Derived flag: 'Yes' if drug_cob_order = 'Primary'"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: drug_is_bci_secondary
        description: "Derived flag: 'Yes' if drug_cob_order = 'Secondary'"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: drug_is_bci_tertiary
        description: "Derived flag: 'Yes' if drug_cob_order = 'Tertiary'"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      - name: drug_two_blues
        description: "Indicates 'Two Blues' scenario for pharmacy coverage"
        tests:
          - not_null
          - accepted_values:
              values: ['Yes', 'No']

      # ========================================================================
      # Metadata
      # ========================================================================
      - name: load_date
        description: "Timestamp when this record was loaded by dbt"
        tests:
          - not_null

      - name: record_source
        description: "Source system metadata (from raw vault member record)"

      - name: hash_diff
        description: |
          Hash of all descriptive COB attributes used for change detection in
          incremental processing. Calculated using dbt_utils.generate_surrogate_key.

# ============================================================================
# Custom Data Quality Tests
# ============================================================================
tests:
  # --------------------------------------------------------------------------
  # Test: No date gaps in member coverage
  # --------------------------------------------------------------------------
  - name: no_date_gaps_in_member_coverage
    description: |
      Ensures that once a member appears in the COB profile, they have continuous
      date coverage with no gaps between periods. Each period's end_date + 1 day
      should equal the next period's effective_date (except for the last period).
    meta:
      test_type: custom
      severity: error

  # --------------------------------------------------------------------------
  # Test: No overlapping date ranges per member
  # --------------------------------------------------------------------------
  - name: no_overlapping_date_ranges
    description: |
      Ensures no member has overlapping date ranges. For any given date, a member
      should have exactly 0 or 1 COB record.
    meta:
      test_type: custom
      severity: error

  # --------------------------------------------------------------------------
  # Test: Valid effectivity date ranges
  # --------------------------------------------------------------------------
  - name: valid_effectivity_dates
    description: "Ensures effective_date <= end_date for all records"
    meta:
      test_type: custom
      severity: error

  # --------------------------------------------------------------------------
  # Test: COB order consistency with indicator flags
  # --------------------------------------------------------------------------
  - name: cob_order_indicator_consistency
    description: |
      Validates that indicator flags match COB order values:
      - If medical_cob_order = 'Primary', then medical_is_bci_primary = 'Yes'
      - If medical_cob_order = 'Secondary', then medical_is_bci_secondary = 'Yes'
      - If medical_cob_order = 'Tertiary', then medical_is_bci_tertiary = 'Yes'
      (Repeated for dental and drug)
    meta:
      test_type: custom
      severity: error

  # --------------------------------------------------------------------------
  # Test: Two Blues carrier validation
  # --------------------------------------------------------------------------
  - name: two_blues_carrier_exists_in_seed
    description: |
      If medical_two_blues = 'Yes', validates that medical_carrier_id exists
      in seed_cob_two_blues_carriers. (Repeated for dental and drug)
    meta:
      test_type: custom
      severity: warn

  # --------------------------------------------------------------------------
  # Test: At least one coverage type per record
  # --------------------------------------------------------------------------
  - name: at_least_one_coverage_type
    description: |
      Ensures every record has at least one coverage type = 'Yes'.
      (medical_coverage = 'Yes' OR dental_coverage = 'Yes' OR drug_coverage = 'Yes')
      Records with no coverage should have been filtered out.
    meta:
      test_type: custom
      severity: error

  # --------------------------------------------------------------------------
  # Test: COB consistency with coverage
  # --------------------------------------------------------------------------
  - name: cob_requires_coverage
    description: |
      Validates business rule: If has_medical_cob = 'Yes', then medical_coverage must = 'Yes'
      Cannot have COB coordination without active coverage.
      (Repeated for dental and drug)
    meta:
      test_type: custom
      severity: error

  # --------------------------------------------------------------------------
  # Test: Only one current record per member
  # --------------------------------------------------------------------------
  - name: only_one_current_per_member
    description: |
      Ensures each member has at most one record with is_current = TRUE
      (end_date = '9999-12-31')
    meta:
      test_type: custom
      severity: error

  # --------------------------------------------------------------------------
  # Test: Tertiary requires prior secondary
  # --------------------------------------------------------------------------
  - name: tertiary_requires_secondary_history
    description: |
      Business rule validation: A member can only have 'Tertiary' COB order if they
      previously had 'Secondary' in an earlier time period. This validates the
      cascading COB logic was applied correctly.
    meta:
      test_type: custom
      severity: warn

# ============================================================================
# SQL Test Implementations (to be created as separate test files)
# ============================================================================
#
# Create these as macros/tests in your dbt project:
#
# tests/custom/no_overlapping_date_ranges.sql
# tests/custom/valid_effectivity_dates.sql
# tests/custom/cob_order_indicator_consistency.sql
# tests/custom/two_blues_carrier_exists_in_seed.sql
# tests/custom/at_least_one_coverage_type.sql
# tests/custom/cob_requires_coverage.sql
# tests/custom/only_one_current_per_member.sql
# tests/custom/tertiary_requires_secondary_history.sql
#
# ============================================================================
