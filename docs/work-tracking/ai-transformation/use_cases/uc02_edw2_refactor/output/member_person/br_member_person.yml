version: 2

models:
  - name: br_member_person
    description: >
      Business vault bridge table mapping members to person (constituent) IDs.
      General-purpose bridge with no filtering - reusable across multiple use cases.
      Use case-specific views apply appropriate filtering (e.g., person_id_type).
      Enables cross-context queries between member and person domains.
    columns:
      - name: member_person_bridge_key
        description: Surrogate key generated from member_bk, source_code, and edp_start_dt
        tests:
          - unique
          - not_null

      - name: member_bk
        description: Member business key from source system
        tests:
          - not_null

      - name: person_bk
        description: Person business key used for joining to person hub
        tests:
          - relationships:
              to: ref('current_person')
              field: person_bk
              severity: warn

      - name: person_id
        description: External constituent ID (EXID) for person lookup across systems
        tests:
          - not_null:
              where: "person_bk is not null"

      - name: person_id_type
        description: >
          Type of person ID (e.g., EXRM for external member).
          Stored in bridge to enable use case-specific filtering in downstream views.

      - name: source_code
        description: >
          Source system identifier translated from numeric code.
          Maps source '1' to 'gemstone_facets', all others to 'legacy_facets'.
        tests:
          - not_null
          - accepted_values:
              values: ['gemstone_facets', 'legacy_facets']

      - name: edp_record_source
        description: Original record source from raw vault member data

      - name: edp_start_dt
        description: Effective start date when this member-person mapping became active
        tests:
          - not_null

      - name: edp_load_dt
        description: Timestamp when this record was loaded into the bridge table
        tests:
          - not_null

      - name: cdc_timestamp
        description: Change data capture timestamp from source system

  - name: v_member_person_lenient
    description: >
      Member-to-person crosswalk with lenient matching strategy for internal and business partner use.
      Replicates legacy v_FacetsMemberUMI_current view functionality.
      Matching Strategy: Lenient - includes EXRM person ID type for broader internal matching.
      Use Cases: Internal reporting, business partner data sharing, analytics.
      Excludes proxy subscribers. For stricter matching (e.g., member portal), use v_member_person_strict.
    columns:
      - name: constituent_id
        description: >
          External person/constituent ID from constituent master.
          NULL when no person mapping exists (left join to bridge).
        tests:
          - not_null:
              severity: warn
              where: "member_bk is not null"

      - name: member_bk
        description: Member business key - primary identifier for member
        tests:
          - not_null

      - name: group_id
        description: Group identifier from source system
        tests:
          - not_null

      - name: subscriber_id
        description: >
          Subscriber identifier from source system.
          Filtered to exclude values starting with 'PROXY'.
        tests:
          - not_null

      - name: member_suffix
        description: Member suffix (e.g., 01, 02 for dependents)

      - name: first_name
        description: Member first name from source system

      - name: last_name
        description: Member last name from source system

      - name: gender
        description: Member gender/sex code from source system

      - name: birth_date
        description: Member birth date from source system
        tests:
          - not_null:
              severity: warn

      - name: ssn
        description: Member social security number from source system (PII)

      - name: source_code
        description: >
          Source system identifier.
          Either 'gemstone_facets' or 'legacy_facets'.
        tests:
          - not_null
          - accepted_values:
              values: ['gemstone_facets', 'legacy_facets']

      - name: dss_record_source
        description: Record source metadata from data vault

      - name: dss_load_date
        description: Date/time when row was loaded into data vault
        tests:
          - not_null

      - name: dss_start_date
        description: Date/time when row became effective in data vault
        tests:
          - not_null

      - name: dss_create_time
        description: CDC timestamp from source system when record was created/modified
        tests:
          - not_null
