version: 2

models:
  - name: prep_member_person
    description: >
      Prep model that applies business rules and joins from legacy v_FacetsMemberUMI_current view.

      This model:
      - Joins member demographics with external person ID from reference data
      - Maps source codes (SourceID=1 -> GEM, else -> FCT)
      - Includes subscriber and group relationships
      - Filters out proxy subscribers
      - Only includes records where external ID type = 'EXRM'

    columns:
      - name: person_id
        description: External constituent/person identifier (EXID_ID from CMC_EXID_EXT_ID)
        tests:
          - not_null

      - name: member_bk
        description: Member business key (natural key from source system)
        tests:
          - not_null
          - unique

      - name: person_bk
        description: Person business key linking to external person record

      - name: group_bk
        description: Group business key for member's group affiliation
        tests:
          - not_null

      - name: subscriber_bk
        description: Subscriber business key for member's subscriber relationship
        tests:
          - not_null

      - name: member_suffix
        description: Member name suffix (Jr., Sr., III, etc.)

      - name: member_first_name
        description: Member's first/given name
        tests:
          - not_null

      - name: member_last_name
        description: Member's last/family name
        tests:
          - not_null

      - name: member_sex
        description: Member's biological sex code
        data_tests:
          - accepted_values:
              arguments:
                values: ['M', 'F', 'U', 'O']

      - name: member_birth_dt
        description: Member's date of birth
        tests:
          - not_null

      - name: member_ssn
        description: Member's Social Security Number (encrypted/masked in production)

      - name: group_id
        description: Group identifier for member's affiliated group
        tests:
          - not_null

      - name: subscriber_identifier
        description: Subscriber identifier
        tests:
          - not_null

      - name: source
        description: >
          Standardized source identifier from the person record.
          Uses standardized source identifiers from the raw vault layer.
          Common values include 'GEM', 'FCT', or other configured source systems.
        tests:
          - not_null

      - name: member_source
        description: Original source system for the member record
        tests:
          - not_null

      - name: edp_record_source
        description: EDP record source identifier

      - name: load_date
        description: Date and time the row was loaded in the data vault
        tests:
          - not_null

      - name: start_date
        description: Date and time the row started in the data vault (effective from)
        tests:
          - not_null

  - name: stg_member_person_business
    description: >
      Staging model that generates hash keys and hashdiff for the member_person
      business vault computed satellite. Prepares data from prep_member_person
      for loading into bv_s_member_person.

    columns:
      - name: member_hk
        description: Hash key for member (parent hub key - hash of source and member_bk, ties to h_member hub)
        tests:
          - not_null
          - unique

      - name: member_person_hashdiff
        description: Hash diff for change detection across all payload columns
        tests:
          - not_null

  - name: bv_s_member_person
    description: >
      Business Vault Computed Satellite: Member Person

      Enriched member person data with external constituent ID and business rules applied.
      This is a computed satellite that derives data from raw vault tables plus business logic.

      Type: Type 2 SCD - Tracks all changes to member person attributes over time

      Parent Hub: h_member (via member_hk)

      Business Logic Applied:
      - Combines member demographics with external person identifier
      - Maps source codes based on source_id
      - Filters for valid subscribers and groups
      - Excludes proxy subscribers

    tests:
      # Test that we don't have duplicate active records
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - member_hk
            - load_datetime

    columns:
      - name: member_hk
        description: Hash key identifying the member entity (parent key - hash of source and member_bk, ties to h_member hub)
        tests:
          - not_null

      - name: member_person_hashdiff
        description: Hash of all payload columns for change detection
        tests:
          - not_null

      - name: person_id
        description: External constituent/person identifier

      - name: member_bk
        description: Member business key (natural key)
        tests:
          - not_null

      - name: person_bk
        description: Person business key linking to external person record

      - name: group_bk
        description: Group business key
        tests:
          - not_null

      - name: subscriber_bk
        description: Subscriber business key
        tests:
          - not_null

      - name: member_suffix
        description: Member name suffix

      - name: member_first_name
        description: Member's first name
        tests:
          - not_null

      - name: member_last_name
        description: Member's last name
        tests:
          - not_null

      - name: member_sex
        description: Member's biological sex code
        tests:
          - accepted_values:
              values: ['M', 'F', 'U', 'O']
              quote: false

      - name: member_birth_dt
        description: Member's date of birth
        tests:
          - not_null

      - name: member_ssn
        description: Member's Social Security Number

      - name: group_id
        description: Group identifier
        tests:
          - not_null

      - name: subscriber_identifier
        description: Subscriber identifier
        tests:
          - not_null

      - name: source
        description: Standardized source identifier from raw vault
        tests:
          - not_null

      - name: member_source
        description: Original source system
        tests:
          - not_null

      - name: effective_from
        description: Effective start date/time for this version of the record
        tests:
          - not_null

      - name: load_datetime
        description: Load date/time into the data vault
        tests:
          - not_null

      - name: record_source
        description: Source system identifier

  - name: xwalk_member_person
    description: >
      Crosswalk Table: Member Person to Person ID

      Provides mapping from member identifiers to external constituent ID.

      Grain: One row per unique member (current records only)

      Lookup Keys:
      - Primary: member_hk (data vault hash key)
      - Alternate: source + member_bk
      - Alternate: source + group_id + subscriber_identifier + member_suffix

      Source: bv_s_member_person (business vault computed satellite)

      Legacy Equivalent: v_FacetsMemberUMI_current

    tests:
      # Ensure primary lookup key is unique
      - unique:
          column_name: member_hk

      # Ensure natural key combination is unique
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - source
            - member_bk

    columns:
      - name: member_hk
        description: Data vault hash key for member (hash of source + member_bk, ties to h_member hub)
        tests:
          - not_null
          - unique

      - name: source
        description: Source system identifier (part of primary lookup key)
        tests:
          - not_null

      - name: member_bk
        description: Member business key (part of primary lookup key)
        tests:
          - not_null

      - name: group_id
        description: Group identifier (part of alternate lookup key)
        tests:
          - not_null

      - name: subscriber_identifier
        description: Subscriber identifier (part of alternate lookup key)
        tests:
          - not_null

      - name: member_suffix
        description: Member name suffix (part of alternate lookup key, defaulted to empty string if null)
        tests:
          - not_null

      - name: person_id
        description: External constituent/person identifier (target value for lookup)

      - name: person_bk
        description: Person business key (additional context)

      - name: group_bk
        description: Group business key (additional context)
        tests:
          - not_null

      - name: subscriber_bk
        description: Subscriber business key (additional context)
        tests:
          - not_null

      - name: last_updated_datetime
        description: Date/time when this lookup record was last updated
        tests:
          - not_null

      - name: record_source
        description: Source system identifier
