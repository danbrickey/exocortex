# Data Vault Specifications

Generated specifications for Data Vault entities. These specs are the output of the `@spec-generator` agent and serve as the source of truth for engineer implementation.

## Purpose

- Document design decisions for Data Vault entities
- Provide complete specifications for engineers to implement
- Serve as reference patterns for future entity designs
- Include automatic evaluation reports to ensure completeness before handoff

## Specifications

| File | Entity Type | Key Patterns Shown |
|------|-------------|-------------------|
| [spec_member_hub.md](spec_member_hub.md) | Hub + Satellites + Same-As Link | Multi-source staging, column mapping table, SAL identity resolution |
| [spec_provider_hub.md](spec_provider_hub.md) | Hub + Satellites + Same-As Link | Complex business key logic, organization relationships |
| [spec_subscriber_satellites.md](spec_subscriber_satellites.md) | Satellites on existing hub | Parent hub reference, inherited business keys |
| [spec_member_rating_satellites.md](spec_member_rating_satellites.md) | Satellites on existing hub | Multi-table join to get hub key |
| [spec_member_disability_satellites.md](spec_member_disability_satellites.md) | Satellites on existing hub | Disability tracking with verification history |
| [spec_member_student_status_satellites.md](spec_member_student_status_satellites.md) | Satellites on existing hub | Student eligibility with school enrollment tracking |
| [spec_subscriber_rating_satellites.md](spec_subscriber_rating_satellites.md) | Satellites on existing hub | Subscriber premium rate factoring with geographic rating |
| [spec_subscriber_warning_msg_satellites.md](spec_subscriber_warning_msg_satellites.md) | Satellites on existing hub | Subscriber warning messages with effective dating |
| [spec_subscriber_employment_satellites.md](spec_subscriber_employment_satellites.md) | Satellites on existing hub | Subscriber employment with occupation and location |

## Specification Template Structure

This is the target format for `@spec-generator`. See [spec_template.md](spec_template.md) for the complete template:

```markdown
## [Domain] 360: Build Raw Vault [Entity] Hub and Satellites

**Title:**

**[Domain] 360: Build Raw Vault [Entity] Hub and Satellites**

**Description:**

As a data engineer,  
I want to [create/refactor] the [entity] [objects] in the raw vault,  
So that we can [business value].

**Acceptance Criteria:**

Given [precondition],  
when [action],  
then [expected result].

### Technical Details

#### Business Key

**Type:** [Polymorphic Business Key / Business Key]

```sql
-- Business key columns (for automate_dv)
[column1],
[column2]
```

#### Source Models

**Source Project:** `enterprise_data_platform`

**Source Models Referenced:**
- `stg_[source_system]_facets_hist__dbo_[table_name]` - [description]

#### dbt Models to Build/Refactor

**Rename Views**:
- stg_[entity]_gemstone_facets_rename - Rename columns for gemstone facets
- stg_[entity]_legacy_facets_rename - Rename columns for legacy facets

**Staging Join Example (for Rename views)**:

```sql
source as (
    select
        -- Business Key Expressions
        [business_key_columns],
        -- Other attributes
        [other_columns]
    from {{ ref('enterprise_data_platform', 'stg_gemstone_facets_hist__dbo_[source_table]') }} [alias]
    [join logic]
)
```

**Staging Views**:
- stg_[entity]_gemstone_facets - Stage data from [source_table] for gemstone facets
- stg_[entity]_legacy_facets - Stage data from [source_table] for legacy facets

**Hubs** (using automate_dv hub macro):
- h_[entity] - Hub for [entity] business key

**Satellites** (using automate_dv sat macro):
- s_[entity]_gemstone_facets - Descriptive attributes from Gemstone system
- s_[entity]_legacy_facets - Descriptive attributes from legacy system

**Same-As Links** (using automate_dv link macro):
- sal_[entity]_facets - Same-as link for [entity] identity resolution

#### Source Column Mapping / Payload

| source_table | source_column | target_column | column_description |
|--------------|---------------|---------------|-------------------|
| ... | ... | ... | ... |

**Metadata:**

- Deliverables: [list]
- Dependencies: [list, if applicable]

---

## Specification Evaluation Report

[Automatic evaluation report generated by @spec-generator agent]
```

## Key Patterns

### 1. Title Format
- Format: `[Domain] 360: Build Raw Vault [Entity] Hub and Satellites`
- Domain refers to business domain (e.g., Provider, Member, Claim)
- Entity refers to specific hub/satellite entity (e.g., provider, member, practitioner, claim_line)
- Examples:
  - `Member 360: Build Raw Vault member_disability Satellites`
  - `Provider 360: Build Raw Vault provider Hub and Satellites`

### 2. Structure Order
1. Title
2. Description
3. **Acceptance Criteria** (moved before Technical Details)
4. Technical Details (with subsections)
5. Metadata
6. Evaluation Report (auto-generated)

### 3. automate_dv Macro Usage
- Hubs: `automate_dv hub macro`
- Satellites: `automate_dv sat macro`
- Links/SALs: `automate_dv link macro`

**Important**: Business keys should be specified as individual columns/expressions (one per line), not as concatenated expressions. The automate_dv macros handle concatenation internally.

### 4. Satellite-Only Entities
When adding satellites to an existing hub:
- Reference **Parent Hub** instead of defining a new hub
- Business keys are inherited from the parent hub
- Include complete staging join example to get the hub key from staging data
- All columns from join example must appear in Source Column Mapping table

### 5. Join Patterns by Entity Source

| Entity Source | Join Pattern | Example |
|---------------|--------------|---------|
| **Member entities** (source has `meme_ck`) | `source.meme_ck = mem.meme_ck` → `mem.sbsb_ck = sbsb.sbsb_ck` | member_disability, member_rating |
| **Subscriber entities** (source has `sbsb_ck`) | `source.sbsb_ck = sbsb.sbsb_ck` → `sbsb.sbsb_ck = mem.sbsb_ck` | subscriber_employment, subscriber_rating |

**Note**: The join from subscriber to member uses `sbsb.sbsb_ck = mem.sbsb_ck` (member table has sbsb_ck column linking to subscriber), NOT `sbsb.sbsb_ck = mem.meme_ck`.

### 6. Identity Resolution (Same-As Links)
SAL specs include:
- Join logic to prior system records
- Hash key column for the SAL (`sal_[entity]_facets_hk`)
- Business key mapping for identity resolution
- Description of resolution logic

### 7. Source Column Mapping
- Include `column_description` for all columns
- Use full `table_name` (not `...table_name` shorthand)
- Document business keys, system columns, and payload attributes
- **All columns from staging join example must appear in mapping table**

### 8. Staging Join Examples
- Required when complex joins exist (multiple tables, left/right joins)
- Must explicitly list all columns (no `table.*` wildcards)
- Include both business key expressions and payload columns
- Show complete join conditions with table aliases

### 9. Evaluation Process
All specifications automatically include an evaluation report with:
- Overall completeness score (percentage)
- Completeness checks (10 items)
- Quality checks (6 items)
- Data Vault 2.0 pattern validation (8 items)
- Red flags and implementation blockers
- Pre-handoff questions (6 questions)
- Recommendations and next steps

**Status**: Specifications must achieve "Ready for Handoff" status before being assigned to engineers.

## Notes

- **YAML test blocks are NOT included** in specifications - tests are defined separately by engineers during implementation
- **Architect Estimate is NOT included** in metadata - removed from template
- **Template notes are removed** from final specs - they're for agent guidance only, not engineers
- Specifications focus on design intent and column mappings, not implementation details
- Evaluation reports are automatically generated and should be reviewed before handoff